<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>Chat App with OpenRouter</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="nav.css">
  <style>
    body {
      margin: 0;
      background: #EDEDED;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .header-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 67px;
      background-image: url('../ì´ë¯¸ì§€/ìƒë‹¨ë°”.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 1000;
    }

    .app {
      width: 380px;
      height: 750px;
      background: #FFFFFF;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .chat-area {
      position: absolute;
      top: 68px;
      /* ìƒë‹¨ ì´ë¯¸ì§€ ë†’ì´ë§Œí¼ ë„ìš°ê¸° */
      left: 0;
      right: 0;
      bottom: 100px;
      /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ìë¦¬ */
      padding: 10px;
      padding-left: 50px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      background: #fff;
    }

    /* ê³µí†µ ì±„íŒ… ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .chat-message {
      max-width: 70%;
      padding: 10px 13px;
      border-radius: 10px;
      word-break: break-word;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* ì‚¬ìš©ì ë©”ì‹œì§€ - ì˜¤ë¥¸ìª½ ì •ë ¬, ë‹¤ë¥¸ ìƒ‰ */
    .user-m {
      align-self: flex-end;
      background-color: #F7DED0;
      color: #000;
    }

    /* ë´‡ ë©”ì‹œì§€ - ì™¼ìª½ ì •ë ¬, ê¸°ë³¸ìƒ‰ */
    .bot-m {
      position: relative;
      align-self: flex-start;
      background-color: #F1F0F0;
      color: #333;
    }

    .bot-m::before {
      content: '';
      position: absolute;
      left: -40px;
      /* ë©”ì‹œì§€ ì™¼ìª½ ë°”ê¹¥ìœ¼ë¡œ ë‚˜ê°€ê²Œ */
      bottom: 0;
      width: 32px;
      height: 32px;
      background-image: url('../ì´ë¯¸ì§€/ìƒˆì‹¹ì´.png');
      /* ë´‡ ì´ë¯¸ì§€ ê²½ë¡œ */
      background-size: cover;
      background-position: center;
      border-radius: 50%;
    }

    /* ì…ë ¥ì°½ */
    .input-box {
      position: absolute;
      left: 60px;
      top: 650px;
      width: 277px;
      height: 32px;
      background: #F7DED0;
      border: 1px solid #070707;
      border-radius: 17px;
      padding-left: 16px;
      font-size: 12px;
      color: #333;
      /* placeholder ê¸€ì”¨ ìƒ‰ê¹”ê³¼ ë‹¤ë¥´ê²Œ ë³´ì´ê²Œ */
      line-height: 32px;
      border: none;
      outline: none;
      box-sizing: border-box;
    }

    .input-box::placeholder {
      color: #6d6a6a;
      font-weight: 400;
    }

    /* ë§ˆì´í¬ ë²„íŠ¼ ì›í˜• */
    .mic-circle {
      position: absolute;
      left: 306px;
      top: 698px;
      width: 32px;
      height: 32px;
      background: #F7DED0;
      border-radius: 50%;
    }

    /* ë§ˆì´í¬ ì•„ì´ì½˜ */
    .mic-icon {
      position: absolute;
      left: 308px;
      top: 700px;
      width: 28px;
      height: 28px;
      background: url('mic_icon.svg') no-repeat center center;
      background-size: contain;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="app">
    <div class="header-image"></div>
    <div class="chat-area" id="chat-area"></div>
    <input class="input-box" id="input-box" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
    <div class="mic-circle"></div>
    <div class="mic-icon"></div>

    <div class="nav-placeholder"></div>

    <nav id="bottom-nav">
      <a href="main1.html" class="nav-item">
        <span class="material-icons">home</span>
        <span class="nav-label">í™ˆ</span>
      </a>
      <a href="ì»¤ë®¤ë‹ˆí‹°.html" class="nav-item active">
        <span class="material-icons">people</span>
        <span class="nav-label">ì»¤ë®¤ë‹ˆí‹°</span>
      </a>
      <a href="test_0526.html" class="nav-item">
        <span class="material-icons">chat</span>
        <span class="nav-label">AIìƒë‹´</span>
      </a>
      <a href="emo_main.html" class="nav-item">
        <span class="material-icons">mood</span>
        <span class="nav-label">ê°ì •ì²´í¬</span>
      </a>
      <a href="mypage_main.html" class="nav-item">
        <span class="material-icons">person</span>
        <span class="nav-label">ë‚´ì •ë³´</span>
      </a>
    </nav>
  </div>

  <script>
    const m_chat = supabase.createClient(
      'https://fszwgldiafcffgbbtlwo.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzendnbGRpYWZjZmZnYmJ0bHdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2ODE1NjAsImV4cCI6MjA2MzI1NzU2MH0.ZznTYaj-KNjyzZHFwm03X7J3S9XLZrHkCi10XAcQ1JI'
    );



    // ------------------- ì´ ë¶€ë¶„ ìˆ˜ì • í•„ìš” user_idë¥¼ ì§ì ‘ ì“°ì§€ ì•Šê³  ì „í˜ì´ì§€ì—ì„œ ë„˜ì–´ì˜¨ user_id//
    // âœ… ì‚¬ìš©ì ID ë™ì  í• ë‹¹
    const currentUserId = localStorage.getItem("user_id");

    if (!currentUserId) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      throw new Error("user_idê°€ ì—†ìŠµë‹ˆë‹¤.");
    }

    const USER_ID = currentUserId;
    const CURRENT_SESSION = 'sess_' + new Date().toISOString().split('T')[0] + '_' + USER_ID;

    async function saveMessage(role, content) {
      await m_chat.from('m_chat').insert([{
        id: crypto.randomUUID(), user_id: USER_ID, session_id: CURRENT_SESSION,
        role, content, created_at: new Date().toISOString()
      }]);
    }

    async function getLatestEmotion(user_id) {
      const { data, error } = await m_chat
        .from('emotions').select('emot')
        .eq('user_id', user_id)
        .order('log_date', { ascending: false })
        .limit(1).single();

      if (error) {
        console.error("ê°ì • ì¡°íšŒ ì‹¤íŒ¨:", error);
        return null;
      }
      return data?.emot;
    }

    // ì´ê±° ë ìˆ˜ë„ ì•ˆë ìˆ˜ë„ ê·¼ë° ì•ˆë ë“¯ ìˆ˜ì •í•´ì•¼í•¨//
    // ğŸ™‹ ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (login í…Œì´ë¸”)
    async function getUserName(user_id) {
      const { data, error } = await m_chat
        .from('healuLog')
        .select('name')
        .eq('user_id', user_id)
        .single();

      return data?.name || 'ì¹œêµ¬';
    }

    // í•™êµ ë‚´, í•™êµ ë°– ì²­ì†Œë…„ ì„ ë³„ ì‚¬ì „ ì¡°ì‚¬ í…Œì´ë¸” 
    async function getUserCategory(user_id) {
      const { data, error } = await m_chat
        .from('pre_question')
        .select('category')
        .eq('user_id', user_id)
        .single();

      if (error) {
        console.error("ì¹´í…Œê³ ë¦¬ ì¡°íšŒ ì‹¤íŒ¨:", error);
        return null;
      }

      return data?.category;
    }



    async function getEmotionBasedSystemPrompt(user_id) {
      const emotion = await getLatestEmotion(user_id);
      const name = await getUserName(user_id);


      // prompt ë¶€ë¶„ í•„ìš”ì‹œ ìˆ˜ì •//
      if (emotion) {
        return {
          role: "system",
          content: `ë„ˆì˜ ì´ë¦„ì€ ì‚¼. ë‚˜ëŠ” ì‚¼ì´ ì•„ë‹ˆì•¼. ì‚¬ìš©ìì˜ ê°ì •ì€ "${emotion}"ì•¼. ì‚¬ìš©ìì˜ ì´ë¦„ì€ "${name}" ì´ì•¼. ì´ë¦„ì„ ë§¨ ì•ê¸€ìë¥¼ ë¹¼ê³  ë¶ˆëŸ¬. ê·¸ ê°ì •ì„ ì—¼ë‘ì— ë‘ê³  ì¹œêµ¬ì²˜ëŸ¼ ë‹¤ì •í•˜ê²Œ ë§ì„ ê±¸ì–´ì¤˜.`
        };
      } else {
        return {
          role: "system",
          content: `ë„ˆì˜ ì´ë¦„ì€ ì‚¼. ë‚˜ëŠ” ì‚¼ì´ ì•„ë‹ˆì•¼. ì‚¬ìš©ìì˜ ì´ë¦„ì€ "${name}" ì´ì•¼. ì´ë¦„ì„ ë§¨ ì•ê¸€ìë¥¼ ë¹¼ê³  ë¶ˆëŸ¬. ì‚¬ìš©ìì˜ ê°ì •ì„ ëª¨ë¥´ë‹ˆ ê°€ë³ê²Œ ì•ˆë¶€ë¥¼ ë¬»ê³  ëŒ€í™”ë¥¼ ì‹œì‘í•´ì¤˜.`
        };
      }
    }

    async function loadHistory() {
      const { data, error } = await m_chat
        .from('m_chat').select('*')
        .eq('user_id', USER_ID)
        .order('created_at', { ascending: true });

      const chatArea = document.getElementById("chat-area");
      chatArea.innerHTML = '';

      if (error) {
        console.error("ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", error);
        return [];
      }

      data.forEach(msg => {
        const msgDiv = document.createElement("div");
        msgDiv.className = `chat-message ${msg.role === 'user' ? 'user-m' : 'bot-m'}`;
        msgDiv.textContent = msg.content;
        chatArea.appendChild(msgDiv);
      });

      return data;
    }

    async function fetchAIResponse(prompt, history) {
      const formattedHistory = history.map(msg => ({
        role: msg.role, content: msg.content
      }));

      const systemPrompt = await getEmotionBasedSystemPrompt(USER_ID);

      const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": "Bearer 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",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "openai/gpt-3.5-turbo",
          messages: [systemPrompt, ...formattedHistory, { role: "user", content: prompt }]
        })
      });

      if (!response.ok) {
        const errText = await response.text();
        console.error("API ìš”ì²­ ì‹¤íŒ¨", response.status, errText);
        return null;
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }

    async function sendMessage(userInput) {
      const chatArea = document.getElementById("chat-area");

      const userMessage = document.createElement("div");
      userMessage.className = "chat-message user-m";
      userMessage.textContent = userInput;
      chatArea.appendChild(userMessage);
      chatArea.scrollTop = chatArea.scrollHeight;

      const category = await getUserCategory(USER_ID);
      if (category === "í•™êµë°– ì²­ì†Œë…„") {
        await saveMessage('user', userInput);
      }

      
        // âœ… ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” ë¬´ì¡°ê±´ ì €ì¥
        await saveMessage('user', userInput);

      const history = await loadHistory();

      try {
        const reply = await fetchAIResponse(userInput, history);
        if (!reply) return;

        const botMessage = document.createElement("div");
        botMessage.className = "chat-message bot-m";
        botMessage.textContent = reply;
        chatArea.appendChild(botMessage);
        chatArea.scrollTop = chatArea.scrollHeight;

        if (category === "í•™êµë°– ì²­ì†Œë…„") {
          await saveMessage('assistant', reply);
        }
      } catch (error) {
        console.error("OpenRouter í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
      }
    }


    async function startInitialBotMessage() {
      const history = await loadHistory();

      if (history.length === 0) {
        const systemPrompt = await getEmotionBasedSystemPrompt(USER_ID);

        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": "Bearer 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",
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "openai/gpt-3.5-turbo",
            messages: [systemPrompt, { role: "user", content: "ìš”ì¦˜ ê¸°ë¶„ì´ ì–´ë•Œ?" }]
          })
        });

        if (!response.ok) {
          const errText = await response.text();
          console.error("ì´ˆê¸° ê°ì • ë©”ì‹œì§€ ì‹¤íŒ¨:", response.status, errText);
          return;
        }

        const data = await response.json();
        const reply = data.choices[0].message.content;

        const chatArea = document.getElementById("chat-area");
        const botMessage = document.createElement("div");
        botMessage.className = "chat-message bot-m";
        botMessage.textContent = reply;
        chatArea.appendChild(botMessage);
        chatArea.scrollTop = chatArea.scrollHeight;

        await saveMessage("assistant", reply);
      }
    }

    window.addEventListener("DOMContentLoaded", async () => {
      const inputBox = document.getElementById("input-box");
      inputBox.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && inputBox.value.trim() !== "") {
          const msg = inputBox.value.trim();
          inputBox.value = "";
          sendMessage(msg);
        }
      });

      await loadHistory();
      await startInitialBotMessage();
    });
  </script>
</body>

</html>